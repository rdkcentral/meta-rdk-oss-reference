From 972c703466702b0796504f2db45f951a1c92b1ba Mon Sep 17 00:00:00 2001
From: skondu363 <Srihariraghava_konduritirumala@comcast.com>
Subject: [PATCH]
Date: Jan 7, 2025
From: Srihariraghava_konduritirumala@comcast.com
Source: upstream
        https://ftp.isc.org/isc/bind9/9.18.24/patches/0003-CVE-2023-5679.patch
 CVE:CVE-2023-5679

Signed-off-by: skondu363 <Srihariraghava_konduritirumala@comcast.com>
---
 lib/ns/query.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/lib/ns/query.c b/lib/ns/query.c
index bdd3d94..30504ba 100644
--- a/lib/ns/query.c
+++ b/lib/ns/query.c
@@ -6140,6 +6140,13 @@ query_lookup_stale(ns_client_t *client) {
 	query_ctx_t qctx;
 
 	qctx_init(client, NULL, client->query.qtype, &qctx);
+	if (DNS64(client)) {
+		qctx.qtype = qctx.type = dns_rdatatype_a;
+		qctx.dns64 = true;
+	}
+	if (DNS64EXCLUDE(client)) {
+		qctx.dns64_exclude = true;
+	}
 	dns_db_attach(client->view->cachedb, &qctx.db);
 	client->query.attributes &= ~NS_QUERYATTR_RECURSIONOK;
 	client->query.dboptions |= DNS_DBFIND_STALETIMEOUT;
