Date: Thur, 17 Nov 2022 12:06:11 +0000
From: 31ba3d3545e3e107d8e189d0a260c164add683d0 Mon Sep 17 00:00:00 2001
Subject: [PATCH] RDK-22498, RDK-27733 : Add support for minidumps in Bluetooth
        Add support for minidumps in Bluetooth module.
Source: COMCAST
Signed-off-by: Arjun <arjun_daasuramdass@comcast.com>
---

--- a/Makefile.am.orig	2022-11-17 06:25:30.135371892 +0000
+++ b/Makefile.am	2022-11-17 06:27:24.582997168 +0000
@@ -25,8 +25,8 @@
 pkginclude_HEADERS =
 
 AM_CFLAGS = $(MISC_CFLAGS) $(WARNING_CFLAGS) $(UDEV_CFLAGS) $(LIBEBOOK_CFLAGS) \
-				$(LIBEDATASERVER_CFLAGS) $(ell_cflags)
-AM_LDFLAGS = $(MISC_LDFLAGS)
+				$(LIBEDATASERVER_CFLAGS) $(ell_cflags) $(BREAKPAD_CFLAGS)
+AM_LDFLAGS = $(MISC_LDFLAGS) $(BREAKPAD_LFLAGS)
 
 confdir = $(sysconfdir)/bluetooth
 statedir = $(localstatedir)/lib/bluetooth
--- a/configure.ac.orig	2022-11-17 06:27:35.882960031 +0000
+++ b/configure.ac	2022-11-17 06:31:24.266205506 +0000
@@ -155,6 +155,24 @@
 	AC_SUBST(BACKTRACE_LIBS)
 fi
 
+# Check for breakpad
+BREAKPAD_CFLAGS=" "
+BREAKPAD_LFLAGS=" "
+AC_ARG_ENABLE([breakpad],
+	      AS_HELP_STRING([--enable-breakpad],[enable breakpad support (default is no)]),
+	      [
+	       case "${enableval}" in
+		       yes) BREAKPAD_CFLAGS="-DINCLUDE_BREAKPAD"
+			       BREAKPAD_LFLAGS="-lbreakpadwrapper";;
+		       no) AC_MSG_ERROR([breakpad is disabled]) ;;
+		       *) AC_MSG_ERROR([bad value ${enableval} for --enable-breakpad]) ;;
+		       esac
+		       ],
+		       [echo "breakpad is disabled"])
+
+AC_SUBST(BREAKPAD_CFLAGS)
+AC_SUBST(BREAKPAD_LFLAGS)
+
 AC_ARG_ENABLE(library, AS_HELP_STRING([--enable-library],
 		[install Bluetooth library]), [enable_library=${enableval}])
 AM_CONDITIONAL(LIBRARY, test "${enable_library}" = "yes")
--- a/src/main.c.orig	2022-11-17 06:31:34.830170443 +0000
+++ b/src/main.c	2022-11-17 06:32:31.941980697 +0000
@@ -53,6 +53,10 @@
 #include "agent.h"
 #include "profile.h"
 
+#ifdef INCLUDE_BREAKPAD
+#include "breakpad_wrapper.h"
+#endif
+
 #define BLUEZ_NAME "org.bluez"
 
 #define DEFAULT_PAIRABLE_TIMEOUT           0 /* disabled */
@@ -1220,6 +1224,9 @@
 	umask(0077);
 
 	btd_backtrace_init();
+#ifdef INCLUDE_BREAKPAD
+	breakpad_ExceptionHandler();
+#endif
 
 	mainloop_init();
 
