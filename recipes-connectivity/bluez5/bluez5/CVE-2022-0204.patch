Date: Aug 19, 2022
From: Aravindan NarasimhapuramChakravarthy <aravindan_narasimhapuramchakravarthy@comcast.com>
Subject: CVE-2022-0204 A heap overflow vulnerability was found in bluez in versions prior to 5.63.
An attacker with local network access could pass specially crafted files causing an application to halt or crash, leading to a denial of service.
Fix the following CVEs in bluez5-5.48
1) CVE-2019-8922 - Heap-based buffer overflow in BlueZ 5.48
2) CVE-2020-0556 - Improper access control before version 5.54
3) CVE-2020-27153 - Double free was found in the gatttool disconnect_cb() routine before 5.55
4) CVE-2022-0204 - Heap overflow vulnerability in bluez versions prior to 5.63
Source: Fix backported from bluez5-5.65 (591c546c536b42bef696d027f64aa22434f8c3f0)
Signed-off-by: Aravindan NarasimhapuramChakravarthy <aravindan_narasimhapuramchakravarthy@comcast.com>
---
Index: bluez-5.48/src/shared/gatt-server.c
===================================================================
--- bluez-5.48.orig/src/shared/gatt-server.c
+++ bluez-5.48/src/shared/gatt-server.c
@@ -756,6 +756,20 @@ static void write_complete_cb(struct gat
 	async_write_op_destroy(op);
 }
 
+static uint8_t check_length(uint16_t length, uint16_t offset)
+{
+	if (length > BT_ATT_MAX_VALUE_LEN)
+		return BT_ATT_ERROR_INVALID_ATTRIBUTE_VALUE_LEN;
+
+	if (offset > BT_ATT_MAX_VALUE_LEN)
+		return BT_ATT_ERROR_INVALID_OFFSET;
+
+	if (length + offset > BT_ATT_MAX_VALUE_LEN)
+		return BT_ATT_ERROR_INVALID_ATTRIBUTE_VALUE_LEN;
+
+	return 0;
+}
+
 static void write_cb(uint8_t opcode, const void *pdu,
 					uint16_t length, void *user_data)
 {
@@ -782,6 +796,10 @@ static void write_cb(uint8_t opcode, con
 				(opcode == BT_ATT_OP_WRITE_REQ) ? "Req" : "Cmd",
 				handle);
 
+	ecode = check_length(length, 0);
+	if (ecode)
+		goto error;
+
 	ecode = check_permissions(server, attr, BT_ATT_PERM_WRITE |
 						BT_ATT_PERM_WRITE_AUTHEN |
 						BT_ATT_PERM_WRITE_ENCRYPT);
@@ -1210,6 +1228,10 @@ static void prep_write_cb(uint8_t opcode
 	util_debug(server->debug_callback, server->debug_data,
 				"Prep Write Req - handle: 0x%04x", handle);
 
+	ecode = check_length(length, offset);
+	if (ecode)
+		goto error;
+
 	ecode = check_permissions(server, attr, BT_ATT_PERM_WRITE |
 						BT_ATT_PERM_WRITE_AUTHEN |
 						BT_ATT_PERM_WRITE_ENCRYPT);
