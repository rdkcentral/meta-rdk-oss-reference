Date: Aug 28, 2023
From: RevathiBhavani_Alluri@comcast.com
Source: upstream 
        https://patchwork.yoctoproject.org/project/oe-core/patch/20221208050037.459910-1-chee.yang.lee@intel.com/
Index: dropbear-2020.81/cli-auth.c
===================================================================
--- dropbear-2020.81.orig/cli-auth.c
+++ dropbear-2020.81/cli-auth.c
@@ -267,6 +267,9 @@ void recv_msg_userauth_success() {
 	if DROPBEAR_CLI_IMMEDIATE_AUTH is set */
 
 	TRACE(("received msg_userauth_success"))
+    if (cli_opts.disable_trivial_auth && cli_ses.is_trivial_auth) {
+        dropbear_exit("trivial authentication not allowed");
+    }
 	/* Note: in delayed-zlib mode, setting authdone here 
 	 * will enable compression in the transport layer */
 	ses.authstate.authdone = 1;
Index: dropbear-2020.81/cli-authinteract.c
===================================================================
--- dropbear-2020.81.orig/cli-authinteract.c
+++ dropbear-2020.81/cli-authinteract.c
@@ -114,6 +114,7 @@ void recv_msg_userauth_info_request() {
 	m_free(instruction);
 
 	for (i = 0; i < num_prompts; i++) {
+        cli_ses.is_trivial_auth = 0;
 		unsigned int response_len = 0;
 		prompt = buf_getstring(ses.payload, NULL);
 		cleantext(prompt);
Index: dropbear-2020.81/cli-authpasswd.c
===================================================================
--- dropbear-2020.81.orig/cli-authpasswd.c
+++ dropbear-2020.81/cli-authpasswd.c
@@ -155,7 +155,8 @@ void cli_auth_password() {
 
 	encrypt_packet();
 	m_burn(password, strlen(password));
-
+ 
+    cli_ses.is_trivial_auth = 0;
 	TRACE(("leave cli_auth_password"))
 }
 #endif	/* DROPBEAR_CLI_PASSWORD_AUTH */
Index: dropbear-2020.81/cli-authpubkey.c
===================================================================
--- dropbear-2020.81.orig/cli-authpubkey.c
+++ dropbear-2020.81/cli-authpubkey.c
@@ -176,6 +176,7 @@ static void send_msg_userauth_pubkey(sig
 		buf_putbytes(sigbuf, ses.writepayload->data, ses.writepayload->len);
 		cli_buf_put_sign(ses.writepayload, key, sigtype, sigbuf);
 		buf_free(sigbuf); /* Nothing confidential in the buffer */
+        cli_ses.is_trivial_auth = 0;
 	}
 
 	encrypt_packet();
Index: dropbear-2020.81/cli-runopts.c
===================================================================
--- dropbear-2020.81.orig/cli-runopts.c
+++ dropbear-2020.81/cli-runopts.c
@@ -154,6 +154,7 @@ void cli_getopts(int argc, char ** argv)
 #if DROPBEAR_CLI_ANYTCPFWD
 	cli_opts.exit_on_fwd_failure = 0;
 #endif
+    cli_opts.disable_trivial_auth = 0; 
 #if DROPBEAR_CLI_LOCALTCPFWD
 	cli_opts.localfwds = list_new();
 	opts.listen_fwd_all = 0;
@@ -922,6 +923,7 @@ static void add_extendedopt(const char*
 #if DROPBEAR_CLI_ANYTCPFWD
 			"\tExitOnForwardFailure\n"
 #endif
+            "\tDisableTrivialAuth\n"
 #ifndef DISABLE_SYSLOG
 			"\tUseSyslog\n"
 #endif
@@ -949,5 +951,10 @@ static void add_extendedopt(const char*
 		return;
 	}
 
+    if (match_extendedopt(&optstr, "DisableTrivialAuth") == DROPBEAR_SUCCESS) {
+        cli_opts.disable_trivial_auth = parse_flag_value(optstr);
+        return;
+    }
+
 	dropbear_log(LOG_WARNING, "Ignoring unknown configuration option '%s'", origstr);
 }
Index: dropbear-2020.81/cli-session.c
===================================================================
--- dropbear-2020.81.orig/cli-session.c
+++ dropbear-2020.81/cli-session.c
@@ -165,6 +165,7 @@ static void cli_session_init(pid_t proxy
 	/* Auth */
 	cli_ses.lastprivkey = NULL;
 	cli_ses.lastauthtype = 0;
+    cli_ses.is_trivial_auth = 1;
 
 	/* For printing "remote host closed" for the user */
 	ses.remoteclosed = cli_remoteclosed;
Index: dropbear-2020.81/runopts.h
===================================================================
--- dropbear-2020.81.orig/runopts.h
+++ dropbear-2020.81/runopts.h
@@ -159,6 +159,7 @@ typedef struct cli_runopts {
 #if DROPBEAR_CLI_ANYTCPFWD
 	int exit_on_fwd_failure;
 #endif
+    int disable_trivial_auth;
 #if DROPBEAR_CLI_REMOTETCPFWD
 	m_list * remotefwds;
 #endif
Index: dropbear-2020.81/session.h
===================================================================
--- dropbear-2020.81.orig/session.h
+++ dropbear-2020.81/session.h
@@ -316,6 +316,7 @@ struct clientsession {
 
 	int lastauthtype; /* either AUTH_TYPE_PUBKEY or AUTH_TYPE_PASSWORD,
 						 for the last type of auth we tried */
+    int is_trivial_auth; 
 	int ignore_next_auth_response;
 #if DROPBEAR_CLI_INTERACT_AUTH
 	int auth_interact_failed; /* flag whether interactive auth can still
