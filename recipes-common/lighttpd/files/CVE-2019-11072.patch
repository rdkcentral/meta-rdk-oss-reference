Date: Aug 9, 2022
From: Aravindan NarasimhapuramChakravarthy <aravindan_narasimhapuramchakravarthy@comcast.com>
Subject: [core] fix abort in http-parseopts (fixes #2945)
fix abort in server.http-parseopts with url-path-2f-decode enabled
For more info. - "Security - SIGABRT during GET request handling with url-path-2f-decode enabled"
Source: https://redmine.lighttpd.net/issues/2945 Backported from lighttpd-1.4.66 (32120d5b8b3203fc21ccb9eafb0eaf824bb59354)
Signed-off-by: Aravindan NarasimhapuramChakravarthy <aravindan_narasimhapuramchakravarthy@comcast.com>
---

Index: lighttpd-1.4.53/src/burl.c
===================================================================
--- lighttpd-1.4.53.orig/src/burl.c
+++ lighttpd-1.4.53/src/burl.c
@@ -252,8 +252,10 @@ static int burl_normalize_2F_to_slash_fi
         }
     }
     if (qs >= 0) {
-        memmove(s+j, s+qs, blen - qs);
-        j += blen - qs;
+     const int qslen = blen - qs;
+             memmove(s+j, s+qs, (size_t)qslen);
+	     qs = j;
+	     j += qslen;
     }
     buffer_string_set_length(b, j);
     return qs;
Index: lighttpd-1.4.53/src/t/test_burl.c
===================================================================
--- lighttpd-1.4.53.orig/src/t/test_burl.c
+++ lighttpd-1.4.53/src/t/test_burl.c
@@ -97,6 +97,8 @@ static void test_burl_normalize (void) {
     flags |= HTTP_PARSEOPT_URL_NORMALIZE_PATH_2F_DECODE;
     run_burl_normalize(psrc, ptmp, flags, __LINE__, CONST_STR_LEN("/a/b?c=/"), CONST_STR_LEN("/a/b?c=/"));
     run_burl_normalize(psrc, ptmp, flags, __LINE__, CONST_STR_LEN("/a/b?c=%2f"), CONST_STR_LEN("/a/b?c=/"));
+    run_burl_normalize(psrc, ptmp, flags, __LINE__, CONST_STR_LEN("%2f?"), CONST_STR_LEN("/?"));
+    run_burl_normalize(psrc, ptmp, flags, __LINE__, CONST_STR_LEN("/%2f?"), CONST_STR_LEN("//?"));
     run_burl_normalize(psrc, ptmp, flags, __LINE__, CONST_STR_LEN("/a%2fb"), CONST_STR_LEN("/a/b"));
     run_burl_normalize(psrc, ptmp, flags, __LINE__, CONST_STR_LEN("/a%2Fb"), CONST_STR_LEN("/a/b"));
     run_burl_normalize(psrc, ptmp, flags, __LINE__, CONST_STR_LEN("/a%2fb?c=/"), CONST_STR_LEN("/a/b?c=/"));
