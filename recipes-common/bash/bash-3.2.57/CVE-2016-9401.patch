Date: Fri, 20 Jan 2017 11:47:31 -0500
From: Chet Ramey <chet.ramey@case.edu>
Subject: [PATCH] Bash-4.4 patch 6 Out-of-range negative offsets to popd can cause the shell to crash attempting
to free an invalid memory block. Backport from bash-4.4. CVE-2016-9401
Source: https://lists.gnu.org/archive/html/bug-bash/2016-11/msg00116.html fa741771ed47b30547be63b5b5dbfb51977aca12 Mon Sep 17 00:00:00 2001 https://ftp.gnu.org/pub/gnu/bash/bash-4.4-patches/bash44-006
Signed-off-by: Li Zhou <li.zhou@windriver.com>
----

Index: bash-3.2.57/builtins/pushd.def
===================================================================
--- bash-3.2.57.orig/builtins/pushd.def
+++ bash-3.2.57/builtins/pushd.def
@@ -333,7 +333,7 @@ popd_builtin (list)
 	break;
     }
 
-  if (which > directory_list_offset || (directory_list_offset == 0 && which == 0))
+  if (which > directory_list_offset || (which < -directory_list_offset) || (directory_list_offset == 0 && which == 0))
     {
       pushd_error (directory_list_offset, which_word ? which_word : "");
       return (EXECUTION_FAILURE);
@@ -355,6 +355,11 @@ popd_builtin (list)
 	 remove that directory from the list and shift the remainder
 	 of the list into place. */
       i = (direction == '+') ? directory_list_offset - which : which;
+      if (i < 0 || i > directory_list_offset)
+      {
+       pushd_error (directory_list_offset, which_word ? which_word : "");
+       return (EXECUTION_FAILURE);
+      }
       free (pushd_directory_list[i]);
       directory_list_offset--;
 

