From: dbhat852_comcast <Deepika_Bhat@comcast.com>
Date: Jul 30, 2024 1:50 PM
Source: https://bazaar.launchpad.net/~ecryptfs/ecryptfs/trunk/revision/857#


Index: ecryptfs-utils-106/ChangeLog
===================================================================
--- ecryptfs-utils-106.orig/ChangeLog
+++ ecryptfs-utils-106/ChangeLog
@@ -12,7 +12,12 @@ ecryptfs-utils-74
     - add verbosity to man page
     - decision_graph.* : add ECRYPTFS_NONEMPTY_VALUE_REQUIRED flag for nodes
     - decision_graph.* : add WRONG_VALUE return code to nodes for asking
-      question again
+    question again
+
+   * src/utils/ecryptfs-setup-swap:
+    - debian/ecryptfs-utils.postinst: On upgrade, uncomment underlying
+      unencrypted swap partitions that are referred to by a device link when
+      crypttab and fstab have a "cryptswap*" device referring to them.
 
   [ Dustin Kirkland ]
   * src/utils/ecryptfs-setup-private: fix bug in grep when running with LANG
Index: ecryptfs-utils-106/src/utils/ecryptfs-setup-swap
===================================================================
--- ecryptfs-utils-106.orig/src/utils/ecryptfs-setup-swap
+++ ecryptfs-utils-106/src/utils/ecryptfs-setup-swap
@@ -160,6 +160,24 @@ for swap in $swaps; do
 		i=$((i+1))
 		[ -e "/dev/mapper/cryptswap$i" ] || break
 	done
+	
+	# If this is a GPT partition, mark it as no-auto mounting, to avoid
+	# auto-activating it on boot
+	if [ "$(blkid -p -s PART_ENTRY_SCHEME -o value "$swap")" = "gpt" ]; then
+		drive="${swap%[0-9]*}"
+		partno="${swap#$drive}"
+		if [ -b "$drive" ]; then
+			if printf "x\np\n" | fdisk "$drive" | grep -q "^$swap .* GUID:.*\b63\b"; then
+				echo "$swap is already marked as no-auto"
+			else
+				# toggle flag 63 ("no auto")
+				echo "marking GPT swap partition $swap as no-auto..."
+				# unfortunately fdisk fails on "cannot re-read part table" and is very verbose
+				printf "x\nS\n$partno\n63\nr\nw\n" | fdisk "$drive" >/dev/null 2>&1 || true
+			fi
+		fi
+	fi
+
 	# Add crypttab entry
 	# Use /dev/urandom, since this is not a long lived key (generated each boot),
 	# and so that we don't block booting while waiting for entropy
