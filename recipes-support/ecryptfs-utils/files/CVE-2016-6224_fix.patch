From: dbhat852_comcast <Deepika_Bhat@comcast.com>
Date: Jul 30, 2024 1:50 PM
Source: https://bazaar.launchpad.net/~ecryptfs/ecryptfs/trunk/revision/882#


Index: ecryptfs-utils-106/ChangeLog
===================================================================
--- ecryptfs-utils-106.orig/ChangeLog
+++ ecryptfs-utils-106/ChangeLog
@@ -19,6 +19,14 @@ ecryptfs-utils-74
       unencrypted swap partitions that are referred to by a device link when
       crypttab and fstab have a "cryptswap*" device referring to them.
 
+  [ Jason Gerard DeRose ]
+  * src/utils/ecryptfs-setup-swap: Prevent unencrypted swap partitions from
+    being automatically enabled by systemd. This bug affected GPT partitioned
+    NVMe/MMC drives and resulted in the swap partition being used without
+    encryption. It also resulted in a usability issue in that users were
+    erroneously prompted to enter a pass-phrase to unlock their swap partition
+    at boot. (LP: #1597154)
+
   [ Dustin Kirkland ]
   * src/utils/ecryptfs-setup-private: fix bug in grep when running with LANG
     in other locales, LP: #347969
Index: ecryptfs-utils-106/src/utils/ecryptfs-setup-swap
===================================================================
--- ecryptfs-utils-106.orig/src/utils/ecryptfs-setup-swap
+++ ecryptfs-utils-106/src/utils/ecryptfs-setup-swap
@@ -164,8 +164,14 @@ for swap in $swaps; do
 	# If this is a GPT partition, mark it as no-auto mounting, to avoid
 	# auto-activating it on boot
 	if [ "$(blkid -p -s PART_ENTRY_SCHEME -o value "$swap")" = "gpt" ]; then
-		drive="${swap%[0-9]*}"
-		partno="${swap#$drive}"
+		# Correctly handle NVMe/MMC drives, as well as any similar physical
+		# block device that follow the "/dev/foo0p1" pattern (LP: #1597154)
+		if echo "$swap" | grep -qE "^/dev/.+[0-9]+p[0-9]+$"; then
+			drive=$(echo "$swap" | sed "s:\(.\+[0-9]\)p[0-9]\+:\1:")
+		else
+			drive=$(echo "$swap" | sed "s:\(.\+[^0-9]\)[0-9]\+:\1:")
+		fi
+		partno=$(echo "$swap" | sed "s:.\+[^0-9]\([0-9]\+\):\1:")
 		if [ -b "$drive" ]; then
 			if printf "x\np\n" | fdisk "$drive" | grep -q "^$swap .* GUID:.*\b63\b"; then
 				echo "$swap is already marked as no-auto"
