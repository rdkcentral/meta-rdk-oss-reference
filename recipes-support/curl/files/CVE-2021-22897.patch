Date: Tue 07 Jun 2022
From: Indhuja Avinashi Valliammal Sivasamy <indhuja_avinashivalliammalsivasamy@comcast.com>
Subject: To add patches for curl CVEs
Source: COMCAST
Signed-off-by: Indhuja Avinashi Valliammal Sivasamy <indhuja_avinashivalliammalsivasamy@comcast.com>
Index: curl-7.69.1/lib/vtls/schannel.c
===================================================================
--- curl-7.69.1.orig/lib/vtls/schannel.c
+++ curl-7.69.1/lib/vtls/schannel.c
@@ -322,12 +322,12 @@ get_alg_id_by_name(char *name)
 }

 static CURLcode
-set_ssl_ciphers(SCHANNEL_CRED *schannel_cred, char *ciphers)
+set_ssl_ciphers(SCHANNEL_CRED *schannel_cred, char *ciphers,
+                int *algIds)
 {
   char *startCur = ciphers;
   int algCount = 0;
-  static ALG_ID algIds[45]; /*There are 45 listed in the MS headers*/
-  while(startCur && (0 != *startCur) && (algCount < 45)) {
+  while(startCur && (0 != *startCur) && (algCount < NUMOF_CIPHERS)) {
     long alg = strtol(startCur, 0, 0);
     if(!alg)
       alg = get_alg_id_by_name(startCur);
@@ -566,7 +566,8 @@ schannel_connect_step1(struct connectdat
     }

     if(SSL_CONN_CONFIG(cipher_list)) {
-      result = set_ssl_ciphers(&schannel_cred, SSL_CONN_CONFIG(cipher_list));
+      result = set_ssl_ciphers(&schannel_cred, SSL_CONN_CONFIG(cipher_list),
+                               BACKEND->algIds);
       if(CURLE_OK != result) {
         failf(data, "Unable to set ciphers to passed via SSL_CONN_CONFIG");
         return result;
Index: curl-7.69.1/lib/vtls/schannel.h
===================================================================
--- curl-7.69.1.orig/lib/vtls/schannel.h
+++ curl-7.69.1/lib/vtls/schannel.h
@@ -70,6 +70,8 @@ CURLcode Curl_verify_certificate(struct
 #endif
 #endif

+#define NUMOF_CIPHERS 45 /* There are 45 listed in the MS headers */
+
 struct curl_schannel_cred {
   CredHandle cred_handle;
   TimeStamp time_stamp;
@@ -101,6 +103,7 @@ struct ssl_backend_data {
 #ifdef HAS_MANUAL_VERIFY_API
   bool use_manual_cred_validation; /* true if manual cred validation is used */
 #endif
+  ALG_ID algIds[NUMOF_CIPHERS];
 };
 #endif /* EXPOSE_SCHANNEL_INTERNAL_STRUCTS */

