From ae382ed94d2393aea82ae803bfa1a4ca2e19ee4b Mon Sep 17 00:00:00 2001
From: skondu363 <Srihariraghava_konduritirumala@comcast.com>
Subject: [PATCH]
Date: Jan 7, 2025
From: Srihariraghava_konduritirumala@comcast.com
Source: upstream
        https://github.com/libarchive/libarchive/commit/3006bc5d02ad3ae3c4f9274f60c1f9d2d834734b
CVE: CVE-2024-48957

Signed-off-by: skondu363 <Srihariraghava_konduritirumala@comcast.com>
---
 libarchive/archive_read_support_format_rar.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/libarchive/archive_read_support_format_rar.c b/libarchive/archive_read_support_format_rar.c
index fae7d9b8..dca0ab80 100644
--- a/libarchive/archive_read_support_format_rar.c
+++ b/libarchive/archive_read_support_format_rar.c
@@ -3708,6 +3708,13 @@ execute_filter_audio(struct rar_filter *filter, struct rar_virtual_machine *vm)
     memset(&state, 0, sizeof(state));
     for (j = i; j < length; j += numchannels)
     {
+      /*
+       * The src block should not overlap with the dst block.
+       * If so it would be better to consider this archive is broken.
+       */
+      if (src >= dst)
+        return 0;
+
       int8_t delta = (int8_t)*src++;
       uint8_t predbyte, byte;
       int prederror;
