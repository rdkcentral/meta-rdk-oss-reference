From 6d8b40501a62b586b156c5b1698f3e3f45c39b4b Mon Sep 17 00:00:00 2001
From: skondu363 <Srihariraghava_konduritirumala@comcast.com>
Date: Fri, 8 Mar 2024 04:38:06 +0000
Subject: [PATCH]
Date: March 8, 2024
From: srihariraghava_konduritirumala@comcast.com
Source: upstream
        https://git.kernel.org/pub/scm/libs/libcap/libcap.git/commit/?id=422bec25ae4a1ab03fd4d6f728695ed279173b18

---
 libcap/cap_alloc.c | 12 +++++++-----
 1 file changed, 7 insertions(+), 5 deletions(-)

diff --git a/libcap/cap_alloc.c b/libcap/cap_alloc.c
index c826e7a..25f9981 100644
--- a/libcap/cap_alloc.c
+++ b/libcap/cap_alloc.c
@@ -105,15 +105,17 @@ char *_libcap_strdup(const char *old)
 	errno = EINVAL;
 	return NULL;
     }
-    len = strlen(old) + 1 + 2*sizeof(__u32);
-    if (len < sizeof(struct _cap_alloc_s)) {
-	len = sizeof(struct _cap_alloc_s);
-    }
-    if ((len & 0xffffffff) != len) {
+
+    len = strlen(old);
+    if ((len & 0x3fffffff) != len) {
 	_cap_debug("len is too long for libcap to manage");
 	errno = EINVAL;
 	return NULL;
     }
+    len += 1 + 2*sizeof(__u32);
+    if (len < sizeof(struct _cap_alloc_s)) {
+       len = sizeof(struct _cap_alloc_s);
+    }
 
     raw_data = calloc(1, len);
     if (raw_data == NULL) {
