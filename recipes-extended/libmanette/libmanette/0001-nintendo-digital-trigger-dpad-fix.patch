From 7278b03e84fb57395c74841bc644e6cf85bd1856 Mon Sep 17 00:00:00 2001
From: Ganesh prasad Sahu <GaneshPrasad_Sahu@comcast.com>
Date: Tue, 6 May 2025 15:36:09 +0000
Subject: [PATCH] nintendo digital trigger dpad fix
Source: COMCAST 
Signed-off-by: Ganesh Sahu <ganeshprasad_sahu@comcast.com>

---
 src/manette-device.c | 35 ++++++++++++++++++++++++++++++++---
 src/manette-device.h |  1 +
 2 files changed, 33 insertions(+), 3 deletions(-)

diff --git a/src/manette-device.c b/src/manette-device.c
index 9ca9254..b9b08a2 100644
--- a/src/manette-device.c
+++ b/src/manette-device.c
@@ -66,6 +66,7 @@ struct _ManetteDevice
   struct input_absinfo abs_info[ABS_MAX];
   gchar *guid;
   gboolean has_rumble;
+  gboolean has_analog_trigger;
 
   ManetteMapping *mapping;
 
@@ -171,6 +172,31 @@ has_abs (struct libevdev *device,
   return libevdev_has_event_code (device, (guint) EV_ABS, code);
 }
 
+gboolean
+manette_device_trigger_type(ManetteDevice *self)
+{
+  g_return_val_if_fail (MANETTE_IS_DEVICE (self), FALSE);
+  return self->has_analog_trigger;
+}
+
+static gboolean
+manette_device_has_analog_trigger(struct libevdev *device)
+{
+  gboolean is_analog_trigger=TRUE;
+
+  g_assert (device != NULL);
+
+  is_analog_trigger =
+    has_abs (device, ABS_GAS) ||
+    has_abs (device, ABS_BRAKE)||
+    has_abs (device, ABS_Z)||
+    has_abs (device, ABS_RZ)||
+    has_abs (device, BTN_TL2)  ||
+    has_abs (device, BTN_TR2);
+
+  return is_analog_trigger;
+}
+
 static gboolean
 is_game_controller (struct libevdev *device)
 {
@@ -480,9 +506,10 @@ on_evdev_event (ManetteDevice      *self,
     case ABS_HAT3X:
     case ABS_HAT3Y:
       manette_event.any.type = MANETTE_EVENT_HAT;
-      manette_event.hat.hardware_index =
-        self->key_map[(evdev_event->code - ABS_HAT0X) / 2] * 2 +
-        (evdev_event->code - ABS_HAT0X) % 2;
+      //To fix key_map set incorrectly due to home button having a value of 256
+      manette_event.hat.hardware_index = (evdev_event->code - ABS_HAT0X) % 2;
+      //self->key_map[(evdev_event->code - ABS_HAT0X) / 2] * 2 +
+      //(evdev_event->code - ABS_HAT0X) % 2;
       manette_event.hat.axis = evdev_event->code;
       manette_event.hat.value = evdev_event->value;
 
@@ -634,6 +661,8 @@ manette_device_new (int      fd,
 
   // Check if rumble is supported
   self->has_rumble = evdev_has_rumble (self->fd);
+  // Check if device has analog trigger
+  self->has_analog_trigger = manette_device_has_analog_trigger(self->evdev_device);
 
   return g_steal_pointer (&self);
 }
diff --git a/src/manette-device.h b/src/manette-device.h
index b97c5c4..4f783c1 100644
--- a/src/manette-device.h
+++ b/src/manette-device.h
@@ -40,6 +40,7 @@ void manette_device_save_user_mapping (ManetteDevice *self,
                                        const gchar   *mapping_string);
 void manette_device_remove_user_mapping (ManetteDevice *self);
 gboolean manette_device_has_rumble (ManetteDevice *self);
+gboolean manette_device_trigger_type(ManetteDevice *self);
 gboolean manette_device_rumble (ManetteDevice *self,
                                 guint16        strong_magnitude,
                                 guint16        weak_magnitude,
-- 
2.25.1

