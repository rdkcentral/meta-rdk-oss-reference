From fe5c2cf40b3ad83ee1ae74357ce440e8e75dc510 Mon Sep 17 00:00:00 2001
From: skondu363 <Srihariraghava_konduritirumala@comcast.com>
Subject: [PATCH]
Date: Jan 7, 2025
From: Srihariraghava_konduritirumala@comcast.com
Source: upstream
        https://github.com/redis/redis/commit/9e505e6cd842338424e05883521ca1fb7d0f47f6
CVE: CVE-2023-41053

Signed-off-by: skondu363 <Srihariraghava_konduritirumala@comcast.com>
---
 src/db.c            | 3 ++-
 tests/unit/sort.tcl | 4 ++++
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/src/db.c b/src/db.c
index f4f37b5..c5ffc58 100644
--- a/src/db.c
+++ b/src/db.c
@@ -2180,7 +2180,8 @@ int sortROGetKeys(struct redisCommand *cmd, robj **argv, int argc, getKeysResult
     keys = getKeysPrepareResult(result, 1);
     keys[0].pos = 1; /* <sort-key> is always present. */
     keys[0].flags = CMD_KEY_RO | CMD_KEY_ACCESS;
-    return 1;
+    result->numkeys = 1;
+    return result->numkeys;
 }
 
 /* Helper function to extract keys from the SORT command.
diff --git a/tests/unit/sort.tcl b/tests/unit/sort.tcl
index a9264ea..760c58c 100644
--- a/tests/unit/sort.tcl
+++ b/tests/unit/sort.tcl
@@ -97,6 +97,10 @@ start_server {
     test "SORT extracts STORE correctly" {
         r command getkeys sort abc store def
     } {abc def}
+    
+    test "SORT_RO get keys" {
+        r command getkeys sort_ro abc
+    } {abc}
 
     test "SORT extracts multiple STORE correctly" {
         r command getkeys sort abc store invalid store stillbad store def
