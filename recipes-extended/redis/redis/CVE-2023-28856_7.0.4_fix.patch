Subject: [PATCH]
Date: june 01, 2024
From: srihariraghava_konduritirumala@comcast.com 
Source: upstream
        https://github.com/redis/redis/commit/bc7fe41e5857a0854d524e2a63a028e9394d2a5c

Signed-off-by: skondu363 <Srihariraghava_konduritirumala@comcast.com>
---
 src/t_hash.c             | 4 ++++
 tests/unit/type/hash.tcl | 5 +++++
 2 files changed, 9 insertions(+)

diff --git a/src/t_hash.c b/src/t_hash.c
index 3079c2a..6816bbc 100644
--- a/src/t_hash.c
+++ b/src/t_hash.c
@@ -670,6 +670,10 @@ void hincrbyfloatCommand(client *c) {
     unsigned int vlen;
 
     if (getLongDoubleFromObjectOrReply(c,c->argv[3],&incr,NULL) != C_OK) return;
+    if (isnan(incr) || isinf(incr)) {
+        addReplyError(c,"value is NaN or Infinity");
+        return;
+    }
     if ((o = hashTypeLookupWriteOrCreate(c,c->argv[1])) == NULL) return;
     if (hashTypeGetValue(o,c->argv[2]->ptr,&vstr,&vlen,&ll) == C_OK) {
         if (vstr) {
diff --git a/tests/unit/type/hash.tcl b/tests/unit/type/hash.tcl
index 4edb146..b720eae 100644
--- a/tests/unit/type/hash.tcl
+++ b/tests/unit/type/hash.tcl
@@ -826,4 +826,9 @@ start_server {tags {"hash"}} {
         set _ $k
     } {ZIP_INT_8B 127 ZIP_INT_16B 32767 ZIP_INT_32B 2147483647 ZIP_INT_64B 9223372036854775808 ZIP_INT_IMM_MIN 0 ZIP_INT_IMM_MAX 12}
 
+    test {HINCRBYFLOAT does not allow NaN or Infinity} {
+        assert_error "*value is NaN or Infinity*" {r hincrbyfloat hfoo field +inf}
+        assert_equal 0 [r exists hfoo]
+    }
+
 }
