From c4e4299f9289c9beb6b01af379e748f42fc61859 Mon Sep 17 00:00:00 2001
From: NareshKumar M <NareshKumar_M@comcast.com>
Date: Mon, 31 Oct 2022 07:50:54 +0000
Subject: [PATCH] Date: Nov 14, 2020 From:
 7be2e452ddcf6d7abca88f41d3761e6edab72b22 Subject: CVE-2020-35524 Source:
 https://gitlab.com/rzkn/libtiff/-/commit/7be2e452ddcf6d7abca88f41d3761e6edab72b22
 License: GPLV2 Upstream-Status:
 https://gitlab.com/rzkn/libtiff/-/commit/7be2e452ddcf6d7abca88f41d3761e6edab72b22
 Signed-off-by:  Even Rouault / nm296(nareshkumar_m@comcast.com)

---
 tools/tiff2pdf.c | 15 ++++++++++++---
 1 file changed, 12 insertions(+), 3 deletions(-)

diff --git a/tools/tiff2pdf.c b/tools/tiff2pdf.c
index 779c166..1a8253a 100644
--- a/tools/tiff2pdf.c
+++ b/tools/tiff2pdf.c
@@ -2063,9 +2063,18 @@ void t2p_read_tiff_size(T2P* t2p, TIFF* input){
 #endif
 		(void) 0;
 	}
-	k = checkMultiply64(TIFFScanlineSize(input), t2p->tiff_length, t2p);
-	if(t2p->tiff_planar==PLANARCONFIG_SEPARATE){
-		k = checkMultiply64(k, t2p->tiff_samplesperpixel, t2p);
+	#ifdef JPEG_SUPPORT
+	if(t2p->pdf_compression == T2P_COMPRESS_JPEG
+	   && t2p->tiff_photometric == PHOTOMETRIC_YCBCR) {
+		k = checkMultiply64(TIFFNumberOfStrips(input), TIFFStripSize(input), t2p);
+	} else
+#endif
+	{
+		k = checkMultiply64(TIFFScanlineSize(input), t2p->tiff_length, t2p);
+		if(t2p->tiff_planar==PLANARCONFIG_SEPARATE){
+			k = checkMultiply64(k, t2p->tiff_samplesperpixel, t2p);
+		}
+
 	}
 	if (k == 0) {
 		/* Assume we had overflow inside TIFFScanlineSize */
