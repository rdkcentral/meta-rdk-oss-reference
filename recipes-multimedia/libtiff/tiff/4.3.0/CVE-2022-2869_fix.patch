Date: Wed, 22 Mar 2023 16:33:09 +0000 
From: Aravindan NarasimhapuramChakravarthy <aravindan_narasimhapuramchakravarthy@comcast.com>
Subject: CVE-2022-2869 Recreated from https://gerrit.teamccp.com/#/c/700748/
Source: https://gitlab.com/libtiff/libtiff/-/merge_requests/294/diffs?commit_id=bcf28bb7f630f24fa47701a9907013f3548092cd f178decc069c9847108ee861b4065c36694b9101 Mon Sep 17 00:00:00 2001
Signed-off-by:  Su Laus / anaras440(aravindan_narasimhapuramchakravarthy@comcast.com)
---

Index: tiff-4.3.0/tools/tiffcrop.c
===================================================================
--- tiff-4.3.0.orig/tools/tiffcrop.c
+++ tiff-4.3.0/tools/tiffcrop.c
@@ -5194,26 +5194,29 @@ computeInputPixelOffsets(struct crop_mas
 	y1 = _TIFFClampDoubleToUInt32(crop->corners[i].Y1);
 	y2 = _TIFFClampDoubleToUInt32(crop->corners[i].Y2);
 	}
-      if (x1 < 1)
-        crop->regionlist[i].x1 = 0;
-      else
-        crop->regionlist[i].x1 = (uint32_t) (x1 - 1);
+      /* region needs to be within image sizes 0.. width-1; 0..length-1
+       *        * - be aware x,y are already casted to (uint32_t) and avoid (0 - 1)
+       *        */
+       if (x1 > image->width - 1)
+           crop->regionlist[i].x1 = image->width - 1;
+       else if (x1 > 0)
+           crop->regionlist[i].x1 = (uint32_t) (x1 - 1);
 
       if (x2 > image->width - 1)
-        crop->regionlist[i].x2 = image->width - 1;
-      else
-        crop->regionlist[i].x2 = (uint32_t) (x2 - 1);
+          crop->regionlist[i].x2 = image->width - 1;
+      else if (x2 > 0)
+	     crop->regionlist[i].x2 = (uint32_t)(x2 - 1);
       zwidth  = crop->regionlist[i].x2 - crop->regionlist[i].x1 + 1; 
 
-      if (y1 < 1)
-        crop->regionlist[i].y1 = 0;
-      else
-        crop->regionlist[i].y1 = (uint32_t) (y1 - 1);
+      if (y1 > image->length - 1)
+	      crop->regionlist[i].y1 = image->length - 1;
+      else if (y1 > 0)
+	      crop->regionlist[i].y1 = (uint32_t)(y1 - 1);
 
       if (y2 > image->length - 1)
         crop->regionlist[i].y2 = image->length - 1;
-      else
-        crop->regionlist[i].y2 = (uint32_t) (y2 - 1);
+      else if (y2 > 0)
+	      crop->regionlist[i].y2 = (uint32_t)(y2 - 1);
 
       zlength = crop->regionlist[i].y2 - crop->regionlist[i].y1 + 1; 
 
@@ -5376,7 +5379,7 @@ computeInputPixelOffsets(struct crop_mas
   crop_width  = endx - startx + 1;
   crop_length = endy - starty + 1;
 
-  if (crop_width <= 0)
+  if (endx + 1 <= startx)
     {
     TIFFError("computeInputPixelOffsets", 
                "Invalid left/right margins and /or image crop width requested");
@@ -5386,7 +5389,7 @@ computeInputPixelOffsets(struct crop_mas
   if (crop_width > image->width)
     crop_width = image->width;
 
-  if (crop_length <= 0)
+  if (endy + 1 <= starty)
     {
     TIFFError("computeInputPixelOffsets", 
               "Invalid top/bottom margins and /or image crop length requested");
