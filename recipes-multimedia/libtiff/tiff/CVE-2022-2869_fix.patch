Date: Mon, 31 Oct 2022 08:00:25 +0000
From: NareshKumar M <NareshKumar_M@comcast.com>
Subject: CVE-2022-2869 
Source: https://gitlab.com/libtiff/libtiff/-/merge_requests/294/diffs?commit_id=bcf28bb7f630f24fa47701a9907013f3548092cd 2cd67ba1eee4cd1b1e8858362bf8fdfd402488f9 Mon Sep 17 00:00:00 2001
Signed-off-by:  Su Laus / nm296(nareshkumar_m@comcast.com)

---
 tools/tiffcrop.c | 36 ++++++++++++++++++++----------------
 1 file changed, 20 insertions(+), 16 deletions(-)

diff --git a/tools/tiffcrop.c b/tools/tiffcrop.c
index 8ef9d2d..b60b774 100644
--- a/tools/tiffcrop.c
+++ b/tools/tiffcrop.c
@@ -5153,26 +5153,30 @@ computeInputPixelOffsets(struct crop_mask *crop, struct image_data *image,
 	y1 = (uint32) (crop->corners[i].Y1);
 	y2 = (uint32) (crop->corners[i].Y2);       
 	}
-      if (x1 < 1)
-        crop->regionlist[i].x1 = 0;
-      else
+       /* region needs to be within image sizes 0.. width-1; 0..length-1
+       * - be aware x,y are already casted to (uint32_t) and avoid (0 - 1)
+       */
+     if (x1 > image->width - 1)
+        crop->regionlist[i].x1 = image->width - 1;
+     else if (x1 > 0)
         crop->regionlist[i].x1 = (uint32) (x1 - 1);
 
       if (x2 > image->width - 1)
-        crop->regionlist[i].x2 = image->width - 1;
-      else
-        crop->regionlist[i].x2 = (uint32) (x2 - 1);
-      zwidth  = crop->regionlist[i].x2 - crop->regionlist[i].x1 + 1; 
+       crop->regionlist[i].x2 = image->width - 1;
+     else if (x2 > 0)
+       crop->regionlist[i].x2 = (uint32_t)(x2 - 1);
+     
+     zwidth  = crop->regionlist[i].x2 - crop->regionlist[i].x1 + 1; 
 
-      if (y1 < 1)
-        crop->regionlist[i].y1 = 0;
-      else
-        crop->regionlist[i].y1 = (uint32) (y1 - 1);
+      if (y1 > image->length - 1)
+        crop->regionlist[i].y1 = image->length - 1;
+      else if (y1 > 0)
+        crop->regionlist[i].y1 = (uint32_t)(y1 - 1);
 
       if (y2 > image->length - 1)
         crop->regionlist[i].y2 = image->length - 1;
-      else
-        crop->regionlist[i].y2 = (uint32) (y2 - 1);
+      else if (y2 > 0)
+        crop->regionlist[i].y2 = (uint32_t)(y2 - 1);
 
       zlength = crop->regionlist[i].y2 - crop->regionlist[i].y1 + 1; 
 
@@ -5333,8 +5337,8 @@ computeInputPixelOffsets(struct crop_mask *crop, struct image_data *image,
   off->endy   = endy;
 
 
-  if (crop_width <= 0)
-    {
+   if (endx + 1 <= startx)
+   {
     TIFFError("computeInputPixelOffsets", 
                "Invalid left/right margins and /or image crop width requested");
     return (-1);
@@ -5342,7 +5346,7 @@ computeInputPixelOffsets(struct crop_mask *crop, struct image_data *image,
   if (crop_width > image->width)
     crop_width = image->width;
 
-  if (crop_length <= 0)
+    if (endy + 1 <= starty)
     {
     TIFFError("computeInputPixelOffsets", 
               "Invalid top/bottom margins and /or image crop length requested");
